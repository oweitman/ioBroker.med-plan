"use strict";(()=>{var L=(e,t,n)=>new Promise((i,l)=>{var r=d=>{try{s(n.next(d))}catch(o){l(o)}},a=d=>{try{s(n.throw(d))}catch(o){l(o)}},s=d=>d.done?i(d.value):Promise.resolve(d.value).then(r,a);s((n=n.apply(e,t)).next())});$.extend(!0,systemDictionary,{});vis.binds["med-plan"]={version:"0.0.1",showVersion:function(){vis.binds["med-plan"].version&&(console.log(`Version med-plan: ${vis.binds["med-plan"].version}`),vis.binds["med-plan"].version=null)},createWidget:function(e,t,n,i){var l=$(`#${e}`);if(!l.length)return setTimeout(function(){vis.binds["med-plan"].createWidget(e,t,n,i)},100);var r="";r+=`OID: ${n.oid||""}<br>`,r+=`OID value: <span class="med-plan-value">${n.oid?vis.states[`${n.oid}.val`]:""}</span><br>`,l.html(r)},createDayPlanWidget:function(e,t,n,i){vis.binds["med-plan"]._createPlanWidgetCommon(e,t,n,i,{mode:"day"})},createMultiDayPlanWidget:function(e,t,n,i){vis.binds["med-plan"]._createPlanWidgetCommon(e,t,n,i,{mode:"multiday"})},_createPlanWidgetCommon:function(e,t,n,i,l){var r=$(`#${e}`);if(!r.length)return setTimeout(function(){vis.binds["med-plan"]._createPlanWidgetCommon(e,t,n,i,l)},100);r.css({overflowY:"auto",overflowX:"hidden"});var a=l&&l.mode?l.mode:"day",s=n.oidpatientOid,d=n.oidmedListOid||"med-plan.0.medication",o=n.showPatientName!==void 0?!!n.showPatientName:!0,h=1,p=7;if(a==="multiday"){var _=parseInt(n.daysPast,10),v=parseInt(n.daysFuture,10);isNaN(_)||(h=_),isNaN(v)||(p=v)}function w(){if(!s){r.html('<div class="med-plan-error">patientOid fehlt.</div>');return}var m=vis.binds["med-plan"]._getStateVal(s),k=vis.binds["med-plan"]._getStateVal(d),f=vis.binds["med-plan"]._safeJsonParse(m,{}),D=vis.binds["med-plan"]._safeJsonParse(k,[]),y=vis.binds["med-plan"]._buildMedicationLookup(D),c=vis.binds["med-plan"]._normalizePatientModel(f,y);if(!c.id){r.html('<div class="med-plan-error">Patientendaten fehlen oder sind ung\xFCltig.</div>');return}var T=new Date,b=new Date(T.getFullYear(),T.getMonth(),T.getDate());if(a==="day"){var M=vis.binds["med-plan"]._formatDateLocalYYYYMMDD(b),N=vis.binds["med-plan"]._formatDateLocalized(b),P=vis.binds["med-plan"]._renderDayTable(c,f,b,M,N,o);r.html(`<div class="med-plan-root">${vis.binds["med-plan"]._wrapDayCard(P)}</div>`)}else{var z='<div class="med-plan-root med-plan-root--multiday">';o&&c.name&&(z+=`<div class="med-plan-header"><div class="med-plan-title">
                        ${vis.binds["med-plan"]._mpMiniIcons.patient}
                        ${vis.binds["med-plan"]._escapeHtml(c.name)}
                    </div></div>`);for(var C=-h;C<=p;C++){var I=new Date(b);I.setDate(b.getDate()+C);var S=vis.binds["med-plan"]._formatDateLocalYYYYMMDD(I),A=vis.binds["med-plan"]._formatDateLocalized(I),H=vis.binds["med-plan"]._renderDayTable(c,f,I,S,A,!1);z+=vis.binds["med-plan"]._wrapDayCard(H)}z+="</div>",r.html(z)}}w(),r.off("click.medplan").on("click.medplan","button.mp-btn",function(){return L(this,null,function*(){var m=$(this),k=m.data("date"),f=m.data("med"),D=m.data("slot"),y=parseInt(m.attr("data-state"),10);isNaN(y)&&(y=0);var c=(y+1)%3;m.attr("data-state",c),m.removeClass("mp-state-0 mp-state-1 mp-state-2").addClass(`mp-state-${c}`),m.prop("disabled",!0).addClass("mp-btn--busy");try{var T=vis.binds["med-plan"]._getInstanceFromOid(s);if(!T)throw new Error(`Cannot derive instance from patientOid: ${s}`);var b={patientOid:s,date:k,medicationId:f,slot:D,state:c};(c===1||c===2)&&(b.ts=Date.now());var M=yield vis.binds["med-plan"]._sendToAsync(T,"setIntakeState",b);if(M&&M.error)throw new Error(M.error)}catch(N){m.attr("data-state",y),m.removeClass("mp-state-0 mp-state-1 mp-state-2").addClass(`mp-state-${y}`),console.error("setIntakeState failed",N),vis.binds["med-plan"]._flashError(r,"Speichern fehlgeschlagen")}finally{m.prop("disabled",!1).removeClass("mp-btn--busy")}})});function u(){w()}var g=[];s&&(vis.states.bind(`${s}.val`,u),g.push(`${s}.val`)),d&&(vis.states.bind(`${d}.val`,u),g.push(`${d}.val`)),r.data("bound",g),r.data("bindHandler",u),vis.binds["med-plan"]._bindMidnightRerender(r,e,w)},_wrapDayCard:function(e){return`<div class="mp-day-card">${e}</div>`},_safeJsonParse:function(e,t){if(e==null||e==="")return t;try{return JSON.parse(e)}catch(n){return t}},_formatDateLocalYYYYMMDD:function(e){var t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${i}`},_formatDateLocalized:function(e,t){try{var n=vis&&vis.language||navigator&&navigator.language||"en-US";return new Intl.DateTimeFormat(n,t||{weekday:"short",year:"numeric",month:"2-digit",day:"2-digit"}).format(e)}catch(i){return e.toLocaleDateString()}},_msUntilNextLocalMidnight:function(){var e=new Date,t=new Date(e);return t.setHours(24,0,0,0),t.getTime()-e.getTime()},_bindMidnightRerender:function(e,t,n){var i=e.data("midnightTimer");i&&(clearTimeout(i),e.removeData("midnightTimer"));var l=setTimeout(function(){n(),vis.binds["med-plan"]._bindMidnightRerender(e,t,n)},vis.binds["med-plan"]._msUntilNextLocalMidnight()+50);e.data("midnightTimer",l)},_getStateVal:function(e){return vis.states[`${e}.val`]},_buildMedicationLookup:function(e){var t={};if(!Array.isArray(e))return t;for(var n=0;n<e.length;n++){var i=e[n];i&&i.id&&(t[i.id]=i)}return t},_normalizePatientModel:function(e,t){var n={id:e&&e.id?e.id:"",name:e&&e.name?e.name:"",medications:[]};if(!n.medications.length){var i=e&&e.plan&&e.plan.meds?e.plan.meds:null;i&&typeof i=="object"&&!Array.isArray(i)&&Object.keys(i).forEach(function(l){var r=i[l]||{},a=t[l]||{},s=Array.isArray(r.packages)?r.packages:[],d=s.map(function(o){o=o||{};var h=typeof o.createdTs=="number"?new Date(o.createdTs).toISOString():o.createdAt||void 0;return{id:o.id,createdTs:o.createdTs,createdAt:h,total:o.total,current:o.current,unit:o.unit,mark:o.mark,marker:o.marker}});n.medications.push({medicationId:l,medicationName:a.name||l||"\u2014",medicationNote:r.note||"",intakeTimes:r.times||r.intakeTimes||{},repeat:r.repeat||{},packages:d})})}return n.medications.sort(function(l,r){var a=(l.medicationName||"").toLowerCase(),s=(r.medicationName||"").toLowerCase();return a<s?-1:a>s?1:(l.medicationId||"").localeCompare(r.medicationId||"")}),n},_slots:[{key:"morning",label:"M"},{key:"noon",label:"Mi"},{key:"evening",label:"A"},{key:"night",label:"N"}],_renderDayTable:function(e,t,n,i,l,r){var a="";r&&e.name?(a+='<div class="med-plan-header">',a+=`<div class="med-plan-title">
                ${vis.binds["med-plan"]._mpMiniIcons.patient}
                ${vis.binds["med-plan"]._escapeHtml(e.name)}
            </div>`,a+=`<div class="med-plan-subtitle">
                ${vis.binds["med-plan"]._mpMiniIcons.date}
                ${l}
            </div>`,a+="</div>"):(a+='<div class="med-plan-header med-plan-header--compact">',a+=`<div class="med-plan-subtitle">
                ${vis.binds["med-plan"]._mpMiniIcons.date}
                ${l}
            </div>`,a+="</div>"),a+='<table class="med-plan-table">',a+="<tbody>";for(var s=0;s<e.medications.length;s++){var d=e.medications[s],o="";try{for(var h=Array.isArray(d.packages)?d.packages:[],p=null,_=0;_<h.length;_++){var v=h[_]||{},w=typeof v.current=="number"?v.current:parseFloat(v.current),u=typeof v.createdTs=="number"?v.createdTs:parseFloat(v.createdTs);!Number.isFinite(w)||w<=0||(Number.isFinite(u)||(u=Number.POSITIVE_INFINITY),(!p||u<p.createdTs)&&(p={createdTs:u,mark:(v.mark||v.marker||"").toString()}))}p&&p.mark&&(o=p.mark)}catch(D){o=""}a+='<tr class="med-plan-row">',a+='<td class="med-plan-med-name">',a+=`
                <span class="med-plan-med-name-main">
                    ${vis.binds["med-plan"]._mpMiniIcons.medication}
                    ${vis.binds["med-plan"]._escapeHtml(d.medicationName)}
                </span>
            `,o&&(a+=`<div class="med-plan-med-packmark">
                    ${vis.binds["med-plan"]._mpMiniIcons.package}
                    ${vis.binds["med-plan"]._escapeHtml(o)}
                </div>`),a+="</td>";for(var g=0;g<vis.binds["med-plan"]._slots.length;g++){var m=vis.binds["med-plan"]._slots[g],k=!!(d.intakeTimes&&d.intakeTimes[m.key]);if(!k){a+='<td class="med-plan-cell med-plan-cell--disabled">',a+=`<button type="button" class="mp-btn mp-btn--disabled" disabled aria-label="${m.key}">`,a+="</button>",a+="</td>";continue}var f=vis.binds["med-plan"]._getIntakeStateFromPatient(t,i,d.medicationId,m.key);a+='<td class="med-plan-cell">',a+=`<button type="button" class="mp-btn mp-state-${f}" data-date="${vis.binds["med-plan"]._escapeAttr(i)}" data-med="${vis.binds["med-plan"]._escapeAttr(d.medicationId)}" data-slot="${vis.binds["med-plan"]._escapeAttr(m.key)}" data-state="${f}" aria-label="${m.key}">`,a+=vis.binds["med-plan"]._icons[m.key]||m.label,a+="</button>",a+="</td>"}if(a+="</tr>",d.medicationNote){let D=1+vis.binds["med-plan"]._slots.length;a+='<tr class="med-plan-row med-plan-row--note">',a+=`<td class="med-plan-note-cell" colspan="${D}">`,a+='<div class="med-plan-note">',a+=vis.binds["med-plan"]._escapeHtml(d.medicationNote),a+="</div>",a+="</td>",a+="</tr>"}}return a+="</tbody>",a+="</table>",a},_escapeHtml:function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},_escapeAttr:function(e){return vis.binds["med-plan"]._escapeHtml(e).replace(/`/g,"&#096;")},_getInstanceFromOid:function(e){var t=(e||"").trim().split(".");return t.length<2?null:`${t[0]}.${t[1]}`},_sendToAsync:function(e,t,n){return new Promise(function(i,l){try{vis.conn.sendTo(e,t,n,function(r){i(r)})}catch(r){l(r)}})},_flashError:function(e,t){var n=e.find(".mp-inline-error");n.length&&n.remove();var i=$('<div class="mp-inline-error"></div>').text(t);e.prepend(i),setTimeout(function(){i.fadeOut(200,function(){i.remove()})},2e3)},_getIntakeStateFromPatient:function(e,t,n,i){var l=e&&e.plan&&e.plan.intake,r=l&&l[t],a=r&&r[n],s=a?a[i]:0;if(s===!0)return 1;if(s===!1)return 0;if(s&&typeof s=="object"&&!Array.isArray(s)){var d=s.state;return d===0||d===1||d===2?d:0}return s===0||s===1||s===2?s:0},_icons:{morning:'<svg class="mp-ic" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"></path></svg>',noon:'<svg class="mp-ic" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 15.31L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"></path></svg>',evening:'<svg class="mp-ic" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6c3.31 0 6 2.69 6 6s-2.69 6-6 6z"></path></svg>',night:'<svg class="mp-ic" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M11.1 12.08c-2.33-4.51-.5-8.48.53-10.07C6.27 2.2 1.98 6.59 1.98 12c0 .14.02.28.02.42.62-.27 1.29-.42 2-.42 1.66 0 3.18.83 4.1 2.15 1.67.48 2.9 2.02 2.9 3.85 0 1.52-.87 2.83-2.12 3.51.98.32 2.03.5 3.11.5 3.5 0 6.58-1.8 8.37-4.52-2.36.23-6.98-.97-9.26-5.41z"></path><path d="M7 16h-.18C6.4 14.84 5.3 14 4 14c-1.66 0-3 1.34-3 3s1.34 3 3 3h3c1.1 0 2-.9 2-2s-.9-2-2-2z"></path></svg>'},_mpMiniIcons:{patient:'<svg class="mp-mini-ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>',date:'<svg class="mp-mini-ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-2V2h-2v2H9V2H7zm12 18H5V9h14v11z"/></svg>',medication:'<svg class="mp-mini-ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M4.22 11.29l8.49-8.49a3 3 0 014.24 4.24l-8.49 8.49a3 3 0 01-4.24-4.24zm1.41 1.41a1 1 0 001.41 1.41l8.49-8.49a1 1 0 10-1.41-1.41l-8.49 8.49z"/></svg>',package:'<svg class="mp-mini-ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 7l-9-5-9 5v10l9 5 9-5V7zm-9-3.18L18.47 7 12 10.18 5.53 7 12 3.82zM5 9.24l6 3.33v6.19l-6-3.33V9.24zm8 9.52v-6.19l6-3.33v6.19l-6 3.33z"/></svg>'}};vis.binds["med-plan"].showVersion();})();
//# sourceMappingURL=med-plan-dist.js.map
